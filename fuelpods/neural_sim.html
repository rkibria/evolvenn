<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<title>Neuro experiment 2 - Neural simulation</title>
<style>
body {background-color: black;}

html *
{
	font-size: 1em;
	color: lightgray;
	font-family: Arial;
}

.float-left-child {
	float: left;
}

/* base css */
body {
	padding: 0px;
}
.parent {
	padding: 0px
}
.child {
	padding: 5px
}

.button {
	background-color: #303030;
	width: 150px;
	border: solid 2px lightgray;
	color: lightgray;
	padding: 5px 3px;
	text-align: center;
	text-decoration: none;
	display: inline-block;
	margin: 4px 2px;
	cursor: pointer;
}

.button1 {font-size: 16px;}

</style>
</head>

<body>

<script src="../drawing.js"></script>
<script src="../vec2.js"></script>
<script src="../random.js"></script>
<script src="../mouse.js"></script>
<script src="../neurallayer.js"></script>
<script src="../neuralnet.js"></script>
<script src="worldmodel.js"></script>
<script src="visualizer.js"></script>
<script src="pilotnet.js"></script>
<script src="neuralpilot.js"></script>

<div class='parent'>
	<div class='child float-left-child'>
		<canvas id="canvas" width="800" height="800" style="border:0px;">Your browser does not support the HTML5 canvas tag.</canvas>
	</div>
	<div class='child float-left-child'>
		<div class='parent'>
			<div class='child float-left-child'>
				<button class="button button1" onclick="onPauseButton()">Toggle pause</button><br>
				<p id="PAUSE_STATUS">Pause OFF</p>
				<hr>
				<button class="button button1" onclick="onRandomizePosButton()">Randomize pos.</button><br>
				<button class="button button1" onclick="onSetPosButton()">Set pos.</button><br>
				<label for="ID_POS_X" title="x position">x</label> <input type="number" id="ID_POS_X" value=0><br>
				<label for="ID_POS_Y" title="y position">y</label> <input type="number" id="ID_POS_Y" value=-300><br>
				<hr>
				Network setup:<br>
				<textarea id="ID_NET_SETUP" rows="5" cols="30">{"nnet":"[{\"nInputs\":13,\"nNeurons\":13,\"weights\":[-41.96717222729673,33.810019222492556,46.19240457510372,-43.72780226660259,-49.51429853400159,-46.25028737297818,1.9923440992508539,-7.297592069054041,2.8902114923289774,-31.035894837187175,-3.072285570078554,0.18029812558555128,22.262942752390472,24.337859031776187,-42.22967947770776,-8.587129672465817,-16.994994385919743,3.1123748533805102,9.344228636926596,58.65158757471573,35.46243094337579,24.679701032838985,-2.16667270824491,44.03959729911619,28.81604650723066,-40.650422709656574,19.49531702544815,26.505096709157367,15.263771254845372,19.492078606118113,50.40065465334455,19.44490143084355,7.9661609305793455,-59.34155982800862,-17.094851209540845,-8.846630638280846,7.509171320465265,48.43680628913334,32.574642554346845,5.327578250058421,37.201121532728976,-2.2068931621495795,-4.808860358394138,13.261111548806648,-35.643098193920046,8.071511779749033,-48.94030507992139,-15.414942543792938,-8.277903129370518,8.19281015642516,-3.002591121875081,16.410520611405225,-2.700951962323363,25.870762319319052,45.17169270912351,17.944577250760673,5.409525289089855,2.722613983233873,17.67310391872674,4.507661138291467,13.701838757916358,6.135612944243231,8.63633671575928,-9.763782856454736,9.678892142657306,-36.37634947440573,16.60223564451593,54.34433973957431,-36.36941505816236,-15.109829304700925,17.199698196762462,10.009428994538734,6.949903832824762,-33.44842770446865,-25.023066548890224,-21.47786918955825,1.9172899574531916,-20.584809606216524,37.15633459949467,17.12180133118972,30.2177399473551,-7.606689895066707,-33.17756648902827,-30.702907444050506,9.522746084165687,18.665283375488727,-1.8708246615937025,-47.17957651777065,26.38495552556556,3.3062809305688297,25.518606189156927,42.935942317086194,8.930284702933882,-5.6554675619129675,7.7223505225150335,9.999329741786397,37.868077218408516,5.923599018661536,-19.11719726204684,9.201176040214657,3.387550810029819,20.004637932309148,-28.74168669813988,8.223873225795739,6.319389170699885,-35.92711284023657,0.7361817693051915,-29.11301214822775,-73.71147122516511,24.687094034528837,15.07363380305611,6.11335755914737,-1.6083038785795496,13.05826639997471,-21.467192543956546,-64.6636877654703,22.22844052677972,5.124644767235941,12.570370070533388,-24.3236291261096,4.49937110607167,-42.35653074882911,7.016431564317519,23.421336276390022,5.782701192658356,0.5869461985659247,-30.95102401315182,-31.274321356519646,-22.85558095611837,13.159066459385624,-4.520677775728599,9.070379912202961,30.400356090441882,-8.565149352642702,-30.763963411344044,-62.44037506940042,6.991631369079365,-6.2716758707738895,-21.73811803631448,-4.488694756943588,13.587199343125532,12.347598383096793,11.526512397749585,29.782959411603418,21.44972659633249,15.124291624660342,53.02356452490834,-9.035050490790221,7.147900392806311,-8.89473936318943,-65.81954175015677,52.901015625678184,-67.55799792956874,3.6396044391819746,3.9683354616739024,-29.216138840015383,-0.5232907384341091,1.3222615824417194,-37.872328994131664,-13.034607769404138,-10.308579664189091,26.14003627775428,-11.950605560640527,-17.68265452054889,-42.99446480085404,7.671162497925183,14.025575358463946,-1.8633308679537537,-6.635977566934011,32.46271422239283,35.98608803667399,28.229728289820294,28.759353752653226,-23.215588075813166,-36.48422174980929,-43.18280277971465,-2.272838433433279,21.473179540362963,-12.853361434808866,20.438295798200233,-18.99575890638589,1.0814063896107384],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":13,\"nNeurons\":13,\"weights\":[21.893500830978198,-29.91002164509716,28.00834326226128,10.06406757388801,0.3160187983612567,3.537662526415648,13.923796628836358,-24.001525838804767,-13.73528908444628,13.115890633653766,4.27517321019197,16.46164670350729,5.9539683178593235,23.998457783906,4.515441784342282,-1.848269128907602,-13.100067011839545,-11.809477853781406,19.147513503502946,24.421344329233023,34.64931103628285,-1.452571782873949,-23.772235821113686,22.00606594331204,48.7054146944481,-4.841405796812067,12.126023321088516,28.492657530627966,0.6782836738364899,-23.697147509949115,1.2146745202193097,38.29267158790322,10.19827226259561,-28.565215028045703,-8.26678477918254,7.519148157902366,26.66784557432011,-17.76078772991726,36.77169446688932,-42.058484978088956,-45.74064405752739,-14.22701093294973,-15.225001266921433,-0.5232415996434046,9.412482706580727,23.480307531887785,15.999109861193787,-7.280208285115369,1.4317817931822123,2.559423347512289,-13.636148220902035,-23.692549381440053,14.58898824641153,-7.965678173030116,33.85496973096572,-10.115045766376468,27.902059111308038,14.78989598872668,-18.888391565147185,-2.3305656347158554,-27.91927243314376,22.722309171683555,-81.2263967648093,-20.678638268074607,-0.921006125286824,15.764096810250686,3.0114026680279915,-42.08995707859275,-23.66212965749839,12.299042607142969,-13.11700907621599,-14.972077213969257,38.416644445346385,-11.853313238100128,-60.4879495998072,3.7108751480238396,-11.059147806821919,-25.422409839782325,16.571524198319626,-12.078432458995435,-27.60871922435687,24.625885056635774,6.740205178987565,-65.22932775831418,3.7378392296925083,-50.496596510318554,-18.700129329965836,-23.506904268687297,48.12783772654748,-22.931916505368314,17.876304423165337,-40.52094836599949,40.22657881534233,-37.433935843459885,19.310984211004516,35.72673628673117,-64.90697345315633,-2.830550791975986,47.568825595090956,3.3168705063233523,1.1677394604681859,-33.17486450908629,75.78505855066634,-14.77394738124315,-43.70901940449113,-1.1605431309865444,-15.868807811660053,3.882818748560929,-7.063181834174505,0.3124082848451234,6.287198814966477,-2.4969056770407367,-1.9635899303002353,48.67248853740099,-23.425858179058455,16.695903143625866,-23.402744491978225,3.859280527674988,-7.4393250026964495,-48.57641813904058,-39.16939864122426,-19.688624451699344,18.746741855177323,24.562678774404283,-44.201327156999895,37.73599145397546,-34.81971125286821,7.9525442505946895,38.33629918670815,-22.136423563661065,-41.593056194442596,-21.69345934519648,-25.031530045742716,-6.19499884088985,-3.078629812586128,48.347321823027464,12.401005826207147,10.340588154173677,7.539179233980897,-14.832162388625832,-8.323216950464651,60.042385248917405,-17.330020295743658,-34.22552128509564,-0.728037173885844,13.794505204536023,-3.576523917128216,11.89921444696729,-25.554450702866095,-11.553727562271218,10.247215745906916,22.728446065749083,2.315468107330039,-4.305991262240962,-19.12423580965617,-36.83368280803218,5.738370620021745,-32.260470954794016,-13.188205800747857,-3.030761033169731,-24.865375966090575,45.87337425489683,14.37740382297547,1.8791488065994884,3.4653663564845036,59.181591265254596,13.811008979612367,-12.419834221622768,-17.964899644702122,13.945212677143969,52.83573841781065,21.62588372682291,16.585504667718826,-14.434209816253423,-20.637270714642263,-28.101455591602498,24.027669285233777,-2.5734631594985804,23.394565789203575,-24.8797618368247,16.79382645183073,0.27979322810638574],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":13,\"nNeurons\":13,\"weights\":[7.553978495623772,-17.907455235818166,15.860561682341551,37.24400529717674,1.8591508235480163,11.907225798986042,-16.454324545964802,1.0250978458334405,11.639475327017632,-14.665156997519622,-23.493755880994566,-55.71838742472329,-12.12323310284763,-56.6087419783202,10.386532590023645,37.65409647578133,-3.959680067767477,30.309241562693582,-33.99056397479866,-6.681190068010139,18.108785667860605,29.202339918179245,-14.929669168570486,-30.597532458828113,46.29844533000626,4.820448303731019,15.694819909209503,-13.903406300022418,-13.519972774822303,26.066722549476452,60.150829071663345,43.82475362702531,45.77198591233226,-17.107856795289855,-20.051844212794148,-7.5268484997202805,-24.96705404806672,3.1649747877558507,-71.06360374247015,21.89319095687781,-27.775961751688367,28.67062514006821,38.20524125311641,-26.151737602697438,-25.97310526304298,-0.49078286339625943,-8.201385498552092,16.26364922003826,-6.527056701038999,10.40783581514,-39.74734749111901,-57.33936969421726,7.665840726025342,-5.698496441375696,-22.055664192173563,33.46825353175935,33.61448878721537,20.86684196355464,-29.57761330907503,1.9488319039586006,-9.449864262756948,3.8608531087129223,5.495774508276109,-21.92525628761016,-4.656554650464378,-0.40206343290600777,11.16734562353005,-18.255439854575673,46.799576101186844,-10.243921992932632,5.832833416431668,-33.82542778137963,8.44819161702452,29.141530863611298,0.8078237626441683,2.0235803192349766,14.666325816704086,-25.331445157755212,33.44313655229935,-36.41627073528729,-13.275114030989714,5.252914680187743,1.7132734067028768,-2.3545105457179325,-1.123220262214269,11.854053640496097,15.84759879234324,12.462898494453347,-31.94649035140037,5.758589876591495,-15.639025335291542,7.727224120088814,41.49278611802998,17.81064923167056,-16.930796861232917,14.143472634664462,19.6721456035019,-20.071709715310618,-2.0034122198679096,52.250702375840824,-34.58030852483018,12.946552176034956,-15.831046377244242,5.29838729710709,20.11416654959769,36.89177221123315,44.04325480330585,-18.865755363780956,3.0818968890338074,26.91132453166498,10.070519295974481,-39.66774722085738,25.500779162458045,6.75207083555923,-12.64024767570362,-13.285050122970473,-18.586593692561163,9.06996126698045,-5.653957561552143,27.040043354491445,-18.91726148103576,-14.773803338348376,8.620454646576967,-1.2405646487195643,-46.47447725082456,-16.977642280623577,48.98512272343555,12.067916682101993,4.557390296817334,42.84257543546289,-16.314945234865622,-41.28094447804363,-19.258652492257042,-21.39073339443456,2.697330596263637,-13.932153298448831,-17.950671991817117,6.8549493966817066,28.590510355116315,8.175591517542717,18.396395391999864,2.6062695901749957,-17.358385239564946,19.615479707130696,2.011500811848597,5.278314297567945,-4.561899954209979,16.23659475343232,6.19857316227356,-31.400836705230482,-11.169461717658033,19.123455663642616,32.306081352497976,36.93298649869469,-11.729591249764367,1.0038233978672675,-26.85455906407521,1.1385302739063405,4.981915488890124,-2.8362770538540976,40.16584502684219,7.604947157232743,8.604336256081895,-17.01652092490974,-23.7805248114675,-2.178020249315638,30.999154558074295,-15.893021426596018,14.604838999357243,-9.07297989028408,-7.019247376638492,-11.98501246889323,20.92702454122085,18.015457749046693,2.507925601322415,-31.12554872118328,-4.472905158942565,27.459884547382902,6.74977478613623,-8.026103781273891,-16.692412319535084,-25.698584494967264],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":13,\"nNeurons\":6,\"weights\":[27.32851752493072,-14.392619193010846,-16.679133241960937,7.962527253892862,50.90222119241345,16.139704417475564,-45.82791815410394,4.173977289268801,24.759251014757353,-30.381590675987404,19.853427496510374,-6.56331748582969,12.982410651307687,3.633915679864468,-4.787994742298946,49.9009288559752,-3.081452655937932,36.63436919290325,58.342383680021314,45.935912539002935,-2.8594527374549186,2.9226498107179064,40.683935513479824,-19.70558180111554,-14.268450123213258,-29.10392092595645,6.902519999841656,-15.49076680234305,34.288397307931575,8.41029987032901,25.373900611430177,-47.86172982352372,4.429077951511332,8.969469721983218,-16.237205241469503,0.8664327283382307,-1.650777163762764,-3.440463865760001,-17.376740649280034,3.308950925291621,-31.395491446914132,11.428503201299812,-10.38215193385427,12.40916343510347,-0.04473805028669159,-2.533090108394101,16.98586913685146,-35.75251139567289,21.572050659822732,-24.680465760797656,-37.47937504624422,-8.984191129307975,-25.456116898706483,-22.863264947692617,-52.41948458627769,-5.513014655247024,9.501421708425301,6.063947542069385,3.8995553460544516,18.759632238497236,-26.278823467164713,-10.436602423307411,23.139105818463477,-16.52286978914683,-12.883921706386358,42.05507881661111,-49.979119145977165,33.35661940405173,21.892811150748802,-25.815863824977722,17.20697771330139,46.92351747657714,4.7761798421771005,65.65175984253553,-73.0580522203941,0.25135815467561184,11.581369173297862,-5.139327172487909,17.629453754991147,-28.075345441986638,-0.2556756779384282,1.5807603356326225,14.097256095714433,15.787811076645342],\"outputs\":[0,0,0,0,0,0]}]"}</textarea><br>
				<button class="button button1" onclick="onLoadNetworkButton()">Load network</button><br>
			</div>
		</div>
	</div>
</div>

<script>

const canvas = document.getElementById('canvas');
const canvasW = canvas.scrollWidth, canvasH = canvas.scrollHeight;

const mouse = captureMouse(canvas);
const mouseclick = captureMouseclick(canvas);

const pilotNet = makePilotNet();
// pilotNet.randomize();
// document.getElementById("ID_NET_SETUP").value = pilotNet.toText();
const g_pilot = new NeuralPilot( new Visualizer( new WorldModel(), 10, 10, 780 ), pilotNet );
onLoadNetworkButton();

let g_paused = false;
setPause(g_paused);

onRandomizePosButton();

let counter = 0;
window.onload = function() {
	const ctx = canvas.getContext('2d');
	ctx.fillStyle = "black";
	ctx.fillRect(0, 0, canvasW, canvasH);

	(function drawFrame () {
		counter += 1;

		window.requestAnimationFrame(drawFrame, canvas);
		ctx.clearRect(0, 0, canvasW, canvasH);
		// const t0 = performance.now();

		g_pilot.run(ctx, !g_paused);

		if(g_pilot.visualizer.model.pods.length == 0) {
			g_pilot.visualizer.drawExplosion(ctx, 5 + 5 * (Math.trunc(counter / 3) % 5));
			setPause(true);
		}

		// const t1 = performance.now();
		// console.log((t1 - t0) + " ms");
	}());
}

function onRandomizePosButton() {
	const pos = new Vec2();
	pos.randomInUnitDisk().multiplyScalar( 500 );
	const vel = new Vec2();
	vel.randomInUnitDisk().multiplyScalar( 5 );
	g_pilot.visualizer.model.rocket.reset(pos, vel);

	g_pilot.visualizer.model.pods = [];
	/*
	for(x = -2; x < 3; ++x) {
		for(y = -2; y < 3; ++y) {
			if(x == 0 || y == 0)
				continue;
			g_pilot.visualizer.model.pods.push( new Vec2().randomInUnitDisk().multiplyScalar( 25 ).addComponents( x * 100, y * 100 ) );
		}
	}
	*/
	g_pilot.visualizer.model.pods.push( new Vec2().randomInUnitDisk().normalize().multiplyScalar( 200 + Math.random() * 200 ) );

	setPause(false);
}

function onSetPosButton() {
	const x = parseFloat(document.getElementById("ID_POS_X").value);
	const y = parseFloat(document.getElementById("ID_POS_Y").value);
	const pos = new Vec2(x, y);
	const vel = new Vec2();
	g_pilot.visualizer.model.rocket.reset(pos, vel);
}

function onLoadNetworkButton() {
	g_pilot.pilotNet.fromText(document.getElementById("ID_NET_SETUP").value);
}

function onPauseButton() {
	setPause(!g_paused);
}

function setPause(doPause) {
	g_paused = doPause;
	document.getElementById("PAUSE_STATUS").innerHTML = "Pause " + (g_paused ? "ON" : "OFF");
}

</script>

</body>
</html>
