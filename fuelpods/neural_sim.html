<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<title>Neuro experiment 2 - Neural simulation</title>
<style>
body {background-color: black;}

html *
{
	font-size: 1em;
	color: lightgray;
	font-family: Arial;
}

.float-left-child {
	float: left;
}

/* base css */
body {
	padding: 0px;
}
.parent {
	padding: 0px
}
.child {
	padding: 5px
}

.button {
	background-color: #303030;
	width: 150px;
	border: solid 2px lightgray;
	color: lightgray;
	padding: 5px 3px;
	text-align: center;
	text-decoration: none;
	display: inline-block;
	margin: 4px 2px;
	cursor: pointer;
}

.button1 {font-size: 16px;}

</style>
</head>

<body>

<script src="../drawing.js"></script>
<script src="../vec2.js"></script>
<script src="../random.js"></script>
<script src="../mouse.js"></script>
<script src="../neurallayer.js"></script>
<script src="../neuralnet.js"></script>
<script src="worldmodel.js"></script>
<script src="visualizer.js"></script>
<script src="pilotnet.js"></script>
<script src="neuralpilot.js"></script>

<div class='parent'>
	<div class='child float-left-child'>
		<canvas id="canvas" width="800" height="800" style="border:0px;">Your browser does not support the HTML5 canvas tag.</canvas>
	</div>
	<div class='child float-left-child'>
		<div class='parent'>
			<div class='child float-left-child'>
				<button class="button button1" onclick="onPauseButton()">Toggle pause</button><br>
				<p id="PAUSE_STATUS">Pause OFF</p>
				<hr>
				<button class="button button1" onclick="onRandomizePosButton()">Randomize pos.</button><br>
				<button class="button button1" onclick="onSetPosButton()">Set pos.</button><br>
				<label for="ID_POS_X" title="x position">x</label> <input type="number" id="ID_POS_X" value=0><br>
				<label for="ID_POS_Y" title="y position">y</label> <input type="number" id="ID_POS_Y" value=-300><br>
				<hr>
				Network setup:<br>
				<textarea id="ID_NET_SETUP" rows="5" cols="30">{"rotScale":0.07396916503518906,"accelScale":0.030824788887832882,"nnet":"[{\"nInputs\":11,\"nNeurons\":11,\"weights\":[-16.653548627511334,-40.66748941602201,-13.300729704054268,-11.102178447935637,-28.935008095486545,-25.45816233306699,-18.65727375970825,-21.758252531695668,30.65714284138005,29.096955262129313,3.825075919102966,-24.175752593113888,17.735595577923725,21.99819228921091,-30.650166411113016,22.91692591026073,70.52622323251079,-16.76165316873528,-7.577152622480345,3.2156952987097425,5.040751126708019,-8.114894059408034,26.63886887847535,16.2936280597168,-18.98192120638035,-27.46599781680722,7.842501456542463,-91.14986217548639,6.417032809721435,27.80792737271275,-7.836032482719894,35.40950322275473,-16.168554641461096,5.885951135063035,-10.227010297668995,45.0854072434285,-28.734662933272542,34.526827471647216,4.237810466609509,19.818968285419388,-13.121147494910064,5.247885058663053,-22.106456060400927,-18.03863371526368,27.183636871940035,-23.239374860108327,28.584795515370782,-15.128014997063866,-53.49578716404125,-30.494175009095265,-14.060511308947813,-9.848671000025648,33.65190847022475,7.971556087263112,-34.13326475470957,-12.009649039451427,28.429993846424868,-2.2225756033636,-37.83014416850835,8.653629514470452,0.2456420263550988,-25.50529269947271,-35.24222455256236,4.059600406640337,35.2771561939978,15.475284315634486,-26.93949987879721,-39.25711858372992,25.748516392622935,40.68401068752972,-34.14585083599763,-17.020185419046985,47.99209122083753,19.363719048226283,-11.28325178934328,7.292901483370176,-50.05894033702915,3.1361459033896266,37.98645861952732,-4.434701012364582,11.10917519921328,0.24073851484897607,-22.57761597867294,-21.78035905917161,-8.966485534888646,-8.494650878710345,-30.387679200878697,-31.67070404218617,24.084879261206602,-8.056401418757302,-15.357670457429164,-17.015825447838186,26.679955204620434,-4.85959731896625,11.478886366196388,9.538565521730167,-24.42094430239975,-2.986517846187505,0.16976642039609235,-23.9645118339872,10.712065430630753,30.18992369457666,-53.79394584261456,-17.675350828632503,38.55230375307704,-33.79566760874068,-23.275175052985386,-6.559115199194376,-10.784235539395038,-33.33660395254003,10.17538279256431,-9.606022737027098,-25.119757419251705,52.917307962150595,36.84158145260266,6.428784077032497,-20.9516178493153,23.9087888563483,-9.659629799230725,10.68961716157134,-17.119496671169856,10.764578262464815,44.50637243209863,-12.408840671263786,14.737044541064233,-4.618210515856107,-15.140631219359113,-33.27650582784706,-3.128368709230653,-26.901778802751707,12.982516598557464,-47.40147316531944],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":11,\"nNeurons\":11,\"weights\":[-9.022154598353476,15.407468753656056,16.355462989718426,-39.66413491445753,-17.760639147583365,47.146997689822136,-40.944243848688615,5.462136071792739,47.9809313521355,7.165027865865739,4.254133400894782,-28.880463665529028,30.271968073366057,2.132872798294725,13.69788045599498,-55.588370532061774,-16.242654393953572,4.936722606994168,37.09794441767419,5.569491160290952,-44.76275201373109,12.148577547089065,35.996084683149924,45.68106544918733,-15.985083293983777,-9.436215065953139,-65.76866839191747,-3.137373946096843,-6.653489417454144,7.556409600009192,-26.643473401744206,17.943896461295335,18.667184145641663,-8.932152665493598,-19.28635413876254,19.159782454180068,33.29121641056658,2.9405270799734975,-27.935129751327946,25.330281818633775,-31.802872609948164,-11.400494504097383,-51.1104080510617,25.006113828183047,-3.1813503003691435,-12.821633092997738,9.109752475276482,23.051613961585616,4.931968627110029,2.4878099374323646,9.903583925042518,3.6190743442302358,-56.98449211767055,-2.2005948737164394,2.489123036507025,-9.779861599148493,-14.72752538093785,-22.15742041776023,-20.796512495734937,19.352885815983182,-34.16988324547012,-1.2268237682336234,15.179320737644284,-32.55768984216084,15.183829651322549,-9.293272380839488,6.650996419079709,17.763556151930732,18.482612573270185,19.829314738380326,29.851380511602358,-1.0889095940301707,25.679132631109407,-23.883844539279075,24.176435227756063,-55.89655269173817,-12.26794512577491,2.7856182046770246,2.0223992809905593,-8.419156747032686,38.092676560004215,-25.228130201551973,28.520805702885255,-1.1371621979060464,26.025184975136256,-2.1010323677758236,5.895154992079852,23.450243274555973,-6.341333061640143,19.88548402978183,24.486310362066504,-33.45362593869133,37.64097575246718,23.832562868321283,-9.343655775182821,-54.21160493603547,3.2940170117536343,13.318839513698483,35.10998831568842,-30.802083071050152,-33.87924337643705,0.6349191832425877,21.682618342343886,-8.232303745664998,-13.414990104335942,39.61507798555809,-2.6916226437523103,9.513496166865444,9.868985552888772,-12.573913855727685,-21.65027391247459,-7.1971631238040406,-37.19562412190835,-16.19454000655841,0.09798401058653326,20.789890212151498,4.8281873168387515,9.582168971170383,15.559445649999114,15.903007422822622,-7.042167584458185,31.005430144769143,-3.188121314043931,35.86144636676011,37.60838953477296,4.852419856596971,-23.778747153875887,-36.51786418122999,19.106276105710307,-3.895842758167122,11.947320256141039,-13.345553307845043],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":11,\"nNeurons\":11,\"weights\":[26.77923341132776,-2.1303404005081927,9.646223112421646,-32.24994539359877,-8.412853230883554,-15.033065368257873,5.289034973867516,34.06741721407063,32.170398387032996,-2.488909438936764,-4.749073087286038,-14.71792259278353,-17.12283003893106,2.8168933222803294,55.913822792784416,2.878195719857355,-18.3786176991805,10.080911612108693,-35.341251760698974,-48.992662831444335,-4.663156905353645,33.28805049553485,-24.396129373559102,-53.80548427541894,25.216307740792107,-15.659185132666448,-27.459433264026057,8.026193272398153,55.94488796117293,25.249457769753896,-17.395565923169585,41.37737969639354,19.652673323392904,6.125891511363342,29.407071906788676,-4.228895284660153,-5.746261934861819,20.542957115696904,0.4944118492553194,-15.407769237651374,27.179779603719062,-17.987646098126685,21.221015339228437,34.282133719180415,-21.218882808322103,-56.282702723922085,-5.064535868089514,-24.11852974907612,-20.18567797648542,14.279533914820293,16.320343536882937,-17.01289258763221,1.8844555613854184,-5.347868093557641,5.923160082316218,11.056383972383703,-30.919102190484864,10.3781029307012,-34.54098529237517,47.29693380595106,8.019347442944918,1.7198895419255713,-6.396863069270676,-13.72076590179367,-25.058745753603542,8.285441923730618,-0.7097234858945829,-14.272691525990469,7.180874408698502,11.357185717321565,-17.50997885803871,4.475974423518017,12.696654004171808,16.40885181256779,-25.45364659177602,-17.940270335322438,-2.4107018529543893,30.972745364576074,-5.7537043241086865,-24.064542914494083,64.1179099021035,16.14148223278291,-88.84276441122543,35.70197715605597,-0.7657052860886692,4.79372462927262,-6.602497638728924,2.0184027816016195,-48.143345363486276,-19.704088683403487,-53.80261509993527,16.066295786516875,17.176417571391955,15.719270590742049,-19.398614253147866,13.645330541569479,3.412579315450352,-24.166070203478462,13.962825167587336,-75.01319232467253,8.711656733340922,-10.41952965469593,-41.326024485599525,-1.5213670718606556,9.263060515700296,3.730540399808618,10.76059762130703,35.19888233523614,-7.46770190177889,-29.761956535867576,-41.92345868251009,24.802412206708414,43.719427121924134,1.0099412118367699,21.09605616074133,-0.4513318676360659,-22.601216388831247,-20.411859037976537,30.176223671562607,16.920204684531086,-16.35745399480253,15.173951121990692,-6.999591386418647,-9.090782980444724,-3.531354212811748,8.732856126092642,-31.398216619181635,-20.451861268270253,30.48265061131963,-19.829637233453514,-21.014848888044003,-5.380469306485189],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":11,\"nNeurons\":3,\"weights\":[39.60571832496843,20.14757969335472,16.750885398577285,-2.9417422432613005,-2.8423495980650135,22.328777580183193,5.327588560814571,29.662827320768912,-20.314806931293383,-9.267506623036311,-52.28996136358672,13.328560970587281,16.607803293281815,5.250678253621209,-15.47246431902977,9.69737956161455,-5.022515952715946,-34.87009109507737,51.69706610466112,43.86965397862047,-15.276778664386663,-11.267174174492585,-42.781820585531364,64.86856585134984,3.0946628912022787,-35.862788084543524,18.449736090218273,25.608232967920667,34.95416344294917,43.21587196732801,15.347883402365051,-19.688522570540012,30.756971205638212,43.76356772381777,8.984898200045048,-9.034490546915151],\"outputs\":[0,0,0]}]"}</textarea><br>
				<button class="button button1" onclick="onLoadNetworkButton()">Load network</button><br>
			</div>
		</div>
	</div>
</div>

<script>

const canvas = document.getElementById('canvas');
const canvasW = canvas.scrollWidth, canvasH = canvas.scrollHeight;

const mouse = captureMouse(canvas);
const mouseclick = captureMouseclick(canvas);

const pilotNet = makePilotNet();
// pilotNet.randomize();
// document.getElementById("ID_NET_SETUP").value = pilotNet.toText();
const g_pilot = new NeuralPilot( new Visualizer( new WorldModel(), 10, 10, 780 ), pilotNet );
onLoadNetworkButton();

let g_paused = false;
setPause(g_paused);

onRandomizePosButton();

window.onload = function() {
	const ctx = canvas.getContext('2d');
	ctx.fillStyle = "black";
	ctx.fillRect(0, 0, canvasW, canvasH);

	(function drawFrame () {
		window.requestAnimationFrame(drawFrame, canvas);
		ctx.clearRect(0, 0, canvasW, canvasH);
		// const t0 = performance.now();

		g_pilot.run(ctx, !g_paused);


		// const t1 = performance.now();
		// console.log((t1 - t0) + " ms");
	}());
}

function onRandomizePosButton() {
	const pos = new Vec2();
	pos.randomInUnitDisk().multiplyScalar( 500 );
	const vel = new Vec2();
	vel.randomInUnitDisk().multiplyScalar( 5 );
	g_pilot.visualizer.model.rocket.reset(pos, vel);

	g_pilot.visualizer.model.pods = [];
	for(x = -2; x < 3; ++x) {
		for(y = -2; y < 3; ++y) {
			if(x == 0 || y == 0)
				continue;
			g_pilot.visualizer.model.pods.push( new Vec2().randomInUnitDisk().multiplyScalar( 25 ).addComponents( x * 100, y * 100 ) );
		}
	}

	setPause(false);
}

function onSetPosButton() {
	const x = parseFloat(document.getElementById("ID_POS_X").value);
	const y = parseFloat(document.getElementById("ID_POS_Y").value);
	const pos = new Vec2(x, y);
	const vel = new Vec2();
	g_pilot.visualizer.model.rocket.reset(pos, vel);
}

function onLoadNetworkButton() {
	g_pilot.pilotNet.fromText(document.getElementById("ID_NET_SETUP").value);
}

function onPauseButton() {
	setPause(!g_paused);
}

function setPause(doPause) {
	g_paused = doPause;
	document.getElementById("PAUSE_STATUS").innerHTML = "Pause " + (g_paused ? "ON" : "OFF");
}

</script>

</body>
</html>
