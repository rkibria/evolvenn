<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<title>Neuro experiment 2 - Neural simulation</title>
<style>
body {background-color: black;}

html *
{
	font-size: 1em;
	color: lightgray;
	font-family: Arial;
}

.float-left-child {
	float: left;
}

/* base css */
body {
	padding: 0px;
}
.parent {
	padding: 0px
}
.child {
	padding: 5px
}

.button {
	background-color: #303030;
	width: 150px;
	border: solid 2px lightgray;
	color: lightgray;
	padding: 5px 3px;
	text-align: center;
	text-decoration: none;
	display: inline-block;
	margin: 4px 2px;
	cursor: pointer;
}

.button1 {font-size: 16px;}

</style>
</head>

<body>

<script src="../drawing.js"></script>
<script src="../vec2.js"></script>
<script src="../random.js"></script>
<script src="../mouse.js"></script>
<script src="../neurallayer.js"></script>
<script src="../neuralnet.js"></script>
<script src="worldmodel.js"></script>
<script src="visualizer.js"></script>
<script src="pilotnet.js"></script>
<script src="neuralpilot.js"></script>

<div class='parent'>
	<div class='child float-left-child'>
		<canvas id="canvas" width="800" height="800" style="border:0px;">Your browser does not support the HTML5 canvas tag.</canvas>
	</div>
	<div class='child float-left-child'>
		<div class='parent'>
			<div class='child float-left-child'>
				<button class="button button1" onclick="onPauseButton()">Toggle pause</button><br>
				<p id="PAUSE_STATUS">Pause OFF</p>
				<hr>
				<button class="button button1" onclick="onRandomizePosButton()">Randomize pos.</button><br>
				<button class="button button1" onclick="onSetPosButton()">Set pos.</button><br>
				<label for="ID_POS_X" title="x position">x</label> <input type="number" id="ID_POS_X" value=0><br>
				<label for="ID_POS_Y" title="y position">y</label> <input type="number" id="ID_POS_Y" value=-300><br>
				<hr>
				Network setup:<br>
				<textarea id="ID_NET_SETUP" rows="5" cols="30">{"nnet":"[{\"nInputs\":13,\"nNeurons\":13,\"weights\":[3.961361851230011,-10.863137139190044,19.34103471257766,20.18105035617818,11.308399682739335,3.0299514090966375,32.583550821044284,-16.971414230509186,12.8236267243999,24.89768338799327,-43.618393733333,-9.328462469500609,-11.977443737434395,10.656000505717818,-23.191836780420964,-36.309443702126025,17.584191504591523,-28.985703660933773,35.62027890955969,40.45146054796748,48.85597683662198,21.05767262760283,11.645597380632857,-17.11564958282955,17.602542782804143,-12.495113214630413,17.166357022319815,-7.291186363991638,20.419832466932824,-5.002610112806305,-23.823308484242187,22.545224864521078,2.7500352908553447,-50.643979200144166,6.122862252816228,12.468124346023373,-8.126903764456996,43.52654666877829,-4.446142061276426,9.534087036904129,8.181332139754335,-38.03837342530209,-8.46828917240872,35.43225215403507,-19.718031869674686,-23.105364987460725,0.1364974902840232,-1.1778008386408518,-50.25325300378956,-21.424746159945578,16.894488855964262,-0.9296033924288861,75.18146997003844,15.958300167718779,4.57775681746119,10.173110917460086,6.987855429525944,10.289402550879375,-36.45984535795697,7.163727571376627,-2.8643116633050125,35.86579237595325,27.696525806101313,20.879116740686,18.564935971622692,-39.72432490919018,8.871603710074194,20.116489884822848,-8.610348764578795,-79.06702868363105,18.831437823871273,-41.65083465728798,-22.532693202606282,3.5507937875168887,-6.119354002449548,33.92185578065871,-3.361282264409788,-10.620112174266321,14.529240581779524,-19.339835172889526,-34.25889021525768,22.645499101055048,21.836903098235886,-25.749090664327735,11.863415691403988,-28.42172633841132,-9.579263356392879,0.7354575567272404,-15.307094077721903,29.662714457169656,3.5353577999243644,43.17895659956066,40.3692095166173,-26.20509503849905,-12.108011114872943,49.20377407966002,25.16656681199302,2.8011580214629035,-19.639204120882248,8.205092305393187,12.508427353459195,29.803031978863274,-4.290227734842246,29.817657487247264,5.7076938599805915,34.161709611935485,10.227672780404307,12.060091123367082,-3.4546331032049333,-51.03955318313135,-11.825718441087872,-47.58650332263448,40.10330417539666,-26.20939002212152,-3.9198618242926018,-2.8993485526951215,-30.483672898012614,-10.040481979001353,-44.97099963884559,28.305597928905367,-46.128206471379386,-5.4876637398268056,2.8310908623579607,-7.442756856993564,36.03670515685511,-14.452920628009457,-0.28667279733104556,37.36803007164328,-27.053958956859542,29.451775823909053,6.847731273329152,1.7484156696316258,27.2479881793154,-8.894846828205846,19.908919457076532,-26.014796784274704,7.359412137672233,9.503091742219443,12.890571385057486,-16.299484269721024,36.74470104848184,33.765632300810424,12.752708095159264,12.726251234479452,-16.379314938323176,-8.130691576384143,-10.335812602116524,21.40154490271817,-2.795788368648002,4.547286203089414,-47.86470509932061,-7.171418667950969,-23.91325718926087,-19.750145906891046,30.914784441309923,16.11006726923061,35.346619503883545,2.906351209596981,-46.89568647824019,-34.82295771611589,-28.86773713171097,27.979873511402072,9.202121356431878,19.407893738036382,-15.958368502216743,-6.409228602762604,-26.878544100048536,6.101291879713669,-27.43899125138737,36.78733666989703,-31.4146223431371,61.24232217097232,-11.085742457734947,-9.807454968314955,7.451375293517361,39.37139237053962,14.122957710855125,-24.72632993051103,-34.605447934639976,37.40355208904891,-9.169326858996731,-24.368211139036816],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":13,\"nNeurons\":13,\"weights\":[43.363946099054104,4.442176273315754,-29.256696035588615,-9.387560602311952,39.66891152217109,-27.76715468982499,-1.4943823402401208,14.557988931319441,-26.001814355055767,50.271025619232965,0.5312702159734454,40.80713642505125,41.43532464373653,-9.446905144112092,-8.22677198693986,0.12702547799064606,-47.91332130383107,19.877334521493413,-13.783790639962247,-10.999929995668671,24.747736764434677,-6.341525264465785,11.056683755538524,12.207218360208488,31.882768607349178,10.119654368329858,50.59158342867198,-17.683362179581867,-8.302235602248121,17.809463223809374,-20.588550337046588,-27.143184511165096,15.191333771546837,27.812121521261037,-32.479295235840695,24.957650168180162,-24.6258996745801,14.671268186111302,14.977585066069787,11.404722924017003,-4.91136364688827,29.91824380664762,-5.597545878524157,-23.749190091908222,5.478465200496505,-12.711738290836651,26.722808658437238,7.211361179796695,49.04515245893113,-43.85257432380845,18.08447546825705,-21.169203939173325,-3.3084761804715876,-5.032441120091201,-19.15869860394224,10.270183787204605,35.843069922275326,-19.192936307192113,-25.063218899417873,28.921575514141896,19.418480868340794,-13.544929115126852,-29.740778176649435,42.501663939365926,4.094227868507233,13.035886861340655,34.36747991828647,-27.65092765763833,31.17453214872097,-4.374317585375266,0.3258312061206761,-12.464855546306172,-32.12484960532515,3.1343902272324113,2.6427055342709562,7.0275987359347,-19.812253440203285,-2.5538739135737725,-8.154428090807896,29.627873175628032,39.38860294639587,-5.537723868176276,-42.94503638297713,20.070192435227387,5.245976027661755,-26.345570439862534,1.7103305672092304,-20.97823654451099,4.6149638387570135,54.882094749855305,-28.76563749615143,26.504571403763727,-9.782434969041171,-16.908527557472354,29.24590064452919,9.637685567706505,-5.844826338881442,-5.144210892018524,18.08389945574354,-20.919218761291642,30.24761695523318,-5.077689389427146,0.7811051585994282,13.363789726472348,1.3765115755510542,25.95377109019849,23.836567802947595,-6.646598166805055,14.255813560322567,12.611552410139325,22.235299508022134,26.899991119035843,-34.07696482921745,50.49750606667375,35.29918737943451,16.606663914255822,-16.537426135945733,12.920978904100778,11.443428216626094,-19.928151947016698,58.703603107818715,11.082590531741843,-4.070039037750233,18.75153589269871,14.920172936605612,43.17194408517301,-25.71256698306492,-3.0932015649857467,-37.58721650407151,18.442032871678336,-14.919363677933418,-6.2850614308965955,-4.1699132569721895,44.86744406654601,-10.358962839895621,-27.686848763070987,-15.196080074433986,-15.12888289900631,-74.4943904618774,16.30491749534309,-8.991879780366624,-15.445199289124446,-34.4337428292427,-8.096329549682887,-8.590946877925868,-9.086013061533183,-25.242772843389716,-30.563219280122382,-2.5842757766655904,9.57816041009562,11.769998107224987,-27.00376115835714,17.921118016351517,16.671973060066396,4.401073776395361,-5.705795422249074,-2.6681741309877722,30.541942742390383,-12.635947788026291,-25.52987646378703,-8.787881701040906,12.7436928289021,13.954495247875188,-33.56860501399639,0.8892116543206998,-3.1397727436008522,-43.962679111745466,3.049169966696698,63.655485570223306,5.338077572961286,38.456205471871336,-20.12170846950852,29.97258702137294,-45.39066126939335,-40.170432951445044,-36.33749759694183,5.275948158690583,-6.039494970735766,-21.5266485808241,-11.38904790960935,26.714688911603844,5.313625386044382],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":13,\"nNeurons\":13,\"weights\":[-15.134837446532185,-8.302007998734695,7.455040373202262,18.354518750426884,14.807576421561352,-41.757120480139555,-11.364658042268857,-3.5355414286316766,19.789286014721654,26.175157202633184,-37.0698961931447,15.41025336182349,29.45536149404432,-15.218739085980738,19.062868328960025,-36.29293476602058,-1.3663245732617173,5.970594842733353,12.524083766606235,25.478918380556955,41.0465238837131,-2.4179955154262407,-35.72209625490538,6.948366554052847,44.99212808685524,18.358949768786946,35.28614719617202,-9.707431169092416,13.319155494248804,33.27450805926525,-36.35487460483622,-30.916255742241347,-15.29980890818554,16.6115046821269,37.488410582298336,-34.12320111009946,14.239685901255285,-9.020579643448908,23.484201206984327,-16.997061680977964,54.32877115437215,-7.700282538033955,36.86795147616789,33.63473077045084,-7.633005958428395,-40.98534740542947,13.423133479766001,2.5762918342673635,-46.303386566504045,41.8276170548466,-7.159497911479433,-65.92382374638738,-3.5569628591476556,2.179281764848397,-51.15935934681462,-24.39572718873444,-62.63255207449353,-35.57773464964273,-28.6627392327484,10.333878040884919,5.453435235460559,23.98445174865543,-12.960058884391426,-8.219233752952814,-28.78917579740056,19.265359122190983,39.70053830972789,90.3203374443676,6.128769662307864,7.0542326311926224,-21.05675458743697,-18.14579418387534,-35.27864519890282,-24.571875487473473,11.514023035423639,57.44586959698382,-0.06401463968218957,33.19325148210498,-22.273694124347536,-60.322123828672254,1.3734261705061241,32.21460209936069,35.0412415339984,-0.171170574596974,-25.877027696087733,-1.2510960395419357,-17.21479208007554,-2.7367610572779215,9.130384365120404,-7.2245911607758675,-50.32262560728729,21.535647726127934,41.974091493985995,42.3785801508315,5.642102928499403,-33.668114145943356,-35.07678677476325,5.581394895875338,11.439847849895203,27.575236035248874,46.88997878313999,26.87111548844404,-23.80935086588214,53.70177116793651,-26.046154407335976,-6.160395170266874,26.549649054855344,13.918488693698945,-19.949030381833886,-16.194128890956243,-9.117249543405698,-4.909770036689209,-13.632293654268205,-18.114861477894184,-7.009743310885122,2.5095857025136943,-0.30029322989152574,-12.502576421117446,2.4224997191628845,30.14540978238404,-17.208811865083664,42.37936466952155,-61.89736183137613,-37.388683917841156,9.436881726781913,20.981101514137514,47.462464848323584,27.216461025719063,-2.8529453700832215,-38.13647627772367,-4.562245480718717,-7.552846228635548,13.212482062619323,5.864661115732574,27.899006816318064,2.783133662258427,-44.926454314256596,8.953033395002965,-27.749665413481768,35.62665204608569,-23.602128358756243,-10.354362617079467,-13.149625434684452,-12.286442677812785,-4.028751874086467,17.45074970109187,19.991766974838136,-73.33553833984384,-6.09503991153794,15.876598220779178,9.025870254590732,49.304198446600985,-11.66823468466571,6.625516719118906,-9.028765344671628,-41.02502213349912,22.442651430509805,-6.38496852352905,-38.17149648927623,-4.8946242380666956,-20.411336336297946,-29.220997777806804,31.335211362365325,-36.09251324746655,-48.47480126622528,-6.173288372390795,49.97560260206347,1.4953020756769295,28.50891855834667,-5.385926273684602,7.923966326686199,-3.6248687009974683,14.24816253904087,5.984666314741153,-5.49428922261051,4.51909436195416,-9.503955669937186,-4.021256831941204,2.2658110471584876,8.833226022876037,-2.122785274709683,58.990973104106196],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":13,\"nNeurons\":6,\"weights\":[13.598873055516368,-11.943742097199808,38.34359709502831,11.784390945028697,1.4061933528090886,2.206887447458162,-13.027026326300819,6.60544478263365,-8.709513447138061,30.0399021875562,-4.8017584642066655,48.48971806866789,-33.55538517272788,12.373422092420054,-1.7632311443631752,36.51915331996303,12.053224472101839,-25.77106117493206,13.762365443166127,33.939986061701504,-8.596317316096311,1.3160465309089235,-14.724923537365413,37.93143411861789,-8.991911136277684,-3.193942423349814,-8.615438192428988,-15.540597502663903,59.09117401361641,14.52675454478626,-3.53841251408481,16.502329338158887,22.99057953296669,27.80902010019872,-38.012612614367754,28.634260913150857,-37.858992313885835,19.988954243783198,-24.66889081943474,-50.82188672661334,-21.893389297898704,-39.02064280658387,3.2453678994536252,2.712266639787409,31.797588700711874,10.023945284553909,-15.47043664310765,-4.140508628149678,9.636726599888117,-22.924191952845444,21.051572879952655,13.922194801908773,-13.88125478923184,-2.2986102685220726,-13.369067415503542,40.989654697835206,-13.765523362962496,33.62413362299635,2.9140718097065563,-15.661266133596039,11.910251209379961,24.930541276736044,-39.66742733344767,7.8800560664081925,6.698783176614851,-3.1771977268839073,33.15531734731832,17.53029242212031,17.053565332111777,-20.733951108128714,11.565208440319063,-9.667302246795574,-22.4615203908112,-22.195491677917452,-26.116949508275138,-7.285910707124116,11.865946009985086,5.03285765989651,-10.39564809069317,-15.563941392787694,-35.38457087748207,-4.507876851057073,9.572100297887047,12.55340318737663],\"outputs\":[0,0,0,0,0,0]}]"}
</textarea><br>
				<button class="button button1" onclick="onLoadNetworkButton()">Load network</button><br>
			</div>
		</div>
	</div>
</div>

<script>

const canvas = document.getElementById('canvas');
const canvasW = canvas.scrollWidth, canvasH = canvas.scrollHeight;

const mouse = captureMouse(canvas);
const mouseclick = captureMouseclick(canvas);

const pilotNet = makePilotNet();
// pilotNet.randomize();
// document.getElementById("ID_NET_SETUP").value = pilotNet.toText();
const g_pilot = new NeuralPilot( new Visualizer( new WorldModel(), 10, 10, 780 ), pilotNet );
onLoadNetworkButton();

let g_paused = false;
setPause(g_paused);

onRandomizePosButton();

let counter = 0;
window.onload = function() {
	const ctx = canvas.getContext('2d');
	ctx.fillStyle = "black";
	ctx.fillRect(0, 0, canvasW, canvasH);

	(function drawFrame () {
		counter += 1;

		window.requestAnimationFrame(drawFrame, canvas);
		ctx.clearRect(0, 0, canvasW, canvasH);
		// const t0 = performance.now();

		g_pilot.run(ctx, !g_paused);

		ctx.save();
		ctx.font = "10px sans-serif";
		ctx.textAlign = "left";
		ctx.strokeStyle = 'white';
		ctx.fillStyle = 'white';
		let ty = 25;
		for(let i = 0; i < pilotNet.inputs.length; ++i) {
			const txt = "in[" + i + "] " + pilotNet.inputs[i];
			ctx.fillText(txt, 20, ty);
			ty += 10;
		}
		ty = 25;
		const outVals = pilotNet.nnet._layers[pilotNet.nnet._layers.length - 1].outputs;
		for(let i = 0; i < outVals.length; ++i) {
			const txt = "out[" + i + "] " + outVals[i];
			ctx.fillText(txt, 200, ty);
			ty += 10;
		}
		ctx.restore();

		if(g_pilot.visualizer.model.pods.length == 0) {
			g_pilot.visualizer.drawExplosion(ctx, 5 + 5 * (Math.trunc(counter / 3) % 5));
			setPause(true);
		}

		// const t1 = performance.now();
		// console.log((t1 - t0) + " ms");
	}());
}

function onRandomizePosButton() {
	const pos = new Vec2();
	pos.randomInUnitDisk().multiplyScalar( 500 );
	const vel = new Vec2();
	vel.randomInUnitDisk().multiplyScalar( 5 );
	g_pilot.visualizer.model.rocket.reset(pos, vel);

	g_pilot.visualizer.model.pods = [];
	/*
	for(x = -2; x < 3; ++x) {
		for(y = -2; y < 3; ++y) {
			if(x == 0 || y == 0)
				continue;
			g_pilot.visualizer.model.pods.push( new Vec2().randomInUnitDisk().multiplyScalar( 25 ).addComponents( x * 100, y * 100 ) );
		}
	}
	*/
	g_pilot.visualizer.model.pods.push( new Vec2().randomInUnitDisk().normalize().multiplyScalar( 200 + Math.random() * 200 ) );

	setPause(false);
}

function onSetPosButton() {
	const x = parseFloat(document.getElementById("ID_POS_X").value);
	const y = parseFloat(document.getElementById("ID_POS_Y").value);
	const pos = new Vec2(x, y);
	const vel = new Vec2();
	g_pilot.visualizer.model.rocket.reset(pos, vel);
}

function onLoadNetworkButton() {
	g_pilot.pilotNet.fromText(document.getElementById("ID_NET_SETUP").value);
}

function onPauseButton() {
	setPause(!g_paused);
}

function setPause(doPause) {
	g_paused = doPause;
	document.getElementById("PAUSE_STATUS").innerHTML = "Pause " + (g_paused ? "ON" : "OFF");
}

</script>

</body>
</html>
