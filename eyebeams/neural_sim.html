<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<title>Neuro experiment 2 - Neural simulation</title>
<style>
body {background-color: black;}

html *
{
	font-size: 1em;
	color: lightgray;
	font-family: Arial;
}

.float-left-child {
	float: left;
}

/* base css */
body {
	padding: 0px;
}
.parent {
	padding: 0px
}
.child {
	padding: 5px
}

.button {
	background-color: #303030;
	width: 150px;
	border: solid 2px lightgray;
	color: lightgray;
	padding: 5px 3px;
	text-align: center;
	text-decoration: none;
	display: inline-block;
	margin: 4px 2px;
	cursor: pointer;
}

.button1 {font-size: 16px;}

</style>
</head>

<body>

<script src="../drawing.js"></script>
<script src="../vec2.js"></script>
<script src="../intersections.js"></script>
<script src="../random.js"></script>
<script src="../mouse.js"></script>
<script src="../neurallayer.js"></script>
<script src="../neuralnet.js"></script>
<script src="worldmodel.js"></script>
<script src="visualizer.js"></script>
<script src="pilotnet.js"></script>
<script src="neuralpilot.js"></script>

<div class='parent'>
	<div class='child float-left-child'>
		<canvas id="canvas" width="800" height="800" style="border:0px;">Your browser does not support the HTML5 canvas tag.</canvas>
	</div>
	<div class='child float-left-child'>
		<div class='parent'>
			<div class='child float-left-child'>
				<button class="button button1" onclick="onPauseButton()">Toggle pause</button><br>
				<p id="PAUSE_STATUS">Pause OFF</p>
				<hr>
				<button class="button button1" onclick="onRandomizePosButton()">Randomize pos.</button><br>
				<button class="button button1" onclick="onSetPosButton()">Set pos.</button><br>
				<label for="ID_POS_X" title="x position">x</label> <input type="number" id="ID_POS_X" value=0><br>
				<label for="ID_POS_Y" title="y position">y</label> <input type="number" id="ID_POS_Y" value=-300><br>
				<hr>
				Network setup:<br>
				<textarea id="ID_NET_SETUP" rows="5" cols="30">{"nnet":"[{\"nInputs\":11,\"nNeurons\":13,\"weights\":[21.775782712203497,-41.712173385313065,-23.273133378253686,2.1550021259008796,-40.1155676960605,10.718060394070612,15.976986415606808,-45.87979779232277,0.26441831772243257,-1.6449121736659436,-12.251248972722212,-0.7459964217425303,-10.494855432687194,6.29959757987105,-1.7177882473640242,16.5935595234226,-3.394260284236891,-32.40594455304235,-18.558781805640407,0.07681161542760997,23.593588618858206,11.32346472962858,-31.65927545495137,16.723816555358347,-16.925595173572972,51.35326204927308,-3.956042374550966,22.076132754633143,23.248572134057042,39.06542429256477,13.346032522423465,7.4026031081028565,-30.095577091220935,-41.16123963400198,-1.5137620397712386,4.249345885749328,-39.166572315715136,3.869738336931896,0.11724904014901977,-50.426893386574186,-18.87626308769532,14.595661590460837,-19.39513483699057,-19.62550644991404,-44.096956414529096,33.7577150219929,16.765509956087975,46.61028584829198,-13.533590360668894,-11.969904266553387,7.551763753862666,35.580217314872876,-5.409071789107163,30.418058880446758,-23.28113684442214,-29.38451763290501,12.689993594401928,13.147789977129896,2.2563071010675992,-7.2261166339887595,40.31545028765105,16.598173063894798,-6.520675256178335,35.8988085339823,-19.339546747675602,-10.750549706819136,-5.711308916603333,34.93658067396314,2.9841288639729067,6.167152311754718,29.47308072036151,-17.9742054048158,11.718316416831698,6.323150381837254,2.9248793313083836,18.479387344111103,42.07849921869242,-18.138017235665956,7.396394227360821,0.14390263440475826,-25.429619135174416,29.839986609995204,-15.049192194104533,3.5819325509885758,-54.95726853160831,19.240573919823422,41.912034663458655,27.02548976818905,-27.829899832319022,-24.990265609964972,5.94066394879656,-3.7574501693382683,-12.068274573480736,-51.565049040564645,-1.691698835489792,12.161301839743961,21.09335479764342,-0.20023919924407418,-18.001890950530274,-16.948695834404056,-23.349675799282505,-1.4046602865568745,4.138545843184045,-3.561469883152472,32.96182297323858,-8.415865773762498,-20.77306660130769,27.46070219021116,-1.9267812179685995,-31.496833953141124,5.730225668775626,4.098498678548264,37.71554549007441,7.846158918744545,-35.10178239808841,-21.54556811958005,-20.47824844650611,-5.302403551088006,-18.37008431538011,33.63173304087439,-31.90276019720652,-15.417378525647946,-41.84159253213764,13.494458926297956,-4.646812155897241,-3.3860086736541697,6.803160690905544,-3.4336784679788597,-9.018538967094628,12.940387964690228,23.388067199036072,-25.771675703202558,1.047956008426994,21.20438247311057,-12.291186303620146,20.866979467323365,-11.562818033261891,8.350786445912277,-38.310211460606205,-9.097576792958431,-19.79151121745054,33.001441204227696,9.966509617852266,37.61889912357627,16.88649410298718,-5.768094436750017,-15.37795379470615,15.419681084780605,44.23911498022785,18.928044723671494,-23.754724249263113,13.562881682064999,-1.2299392113771206,4.175770340695024,-18.018599694139628,32.05270043552081],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":13,\"nNeurons\":13,\"weights\":[-13.10322557824521,6.592844396106576,19.88415347616216,47.94439507753941,28.799544868526574,7.490928477651501,-39.175263131857285,43.15678496106757,16.562150033058217,-12.968009995826687,-31.01463064979629,20.314368918530196,-3.131883257254464,24.129701008257666,24.062192276184106,20.981364165960468,-20.678619404017404,9.028242412872006,-32.81911023381836,-5.000091759796487,24.162910830746434,-27.866811663335092,13.251507676144183,-38.58044447682273,-18.737258764600668,12.016706593374169,-19.37002386342104,7.546869841069347,22.311598586347678,-2.409746442505588,-26.688868688353217,-12.6516172852742,19.209324369907026,32.862073143386816,27.858002713723547,-26.311692564378824,4.874037588056326,-65.84403072027457,7.527055517797038,4.849813480001755,16.917727481888107,26.363428403303413,-12.267254347082783,-40.522112064873745,-1.1387776949096122,-3.991081686454808,-11.731657814283592,-54.87598714823509,-23.40640308492083,-19.436711430552442,8.018189027078707,36.65802230771623,9.017046453262934,28.798293332610044,-6.041968658064215,-21.036188120623805,31.072992275149637,21.28103260458894,23.1122922727691,-9.623725415487076,26.97735296767119,50.212804331493885,0.1577198357436715,35.48723592700636,-13.397179306471966,18.28183173541272,-10.343060285212657,-35.48246477621434,-18.14578488200993,16.801248655825024,20.347663010563863,26.3776168671169,-37.66002127638874,16.87865222332404,-22.51782317054467,33.74963844382755,32.96005209394594,35.55271225687543,26.639315866395968,-11.246170396846386,41.42821664095613,28.72716685677526,-31.968179590678673,35.08752159502841,-17.21094493411531,-7.622776674600312,-2.9450501699999565,-46.661188797416685,-14.636826532538377,-27.155343957623227,-14.528671856634569,-16.64422159715578,-26.06636385094662,-19.211174795163743,-8.73882675460905,15.015163385943689,-24.378836794388047,5.8152039839229275,26.238827573733776,5.062892909642974,25.986315070606896,24.235143650096752,3.6696018419592025,40.3226917222332,-2.508572537552425,9.959408542501142,63.7988743335992,-10.308092196120922,-38.79851469014226,52.518341349846764,25.02004559333392,-16.110830702900866,-14.091156261829449,19.767128070100103,-25.877159537016254,-5.088612748766584,-16.354626052356007,-51.07832116362116,1.3187385309954849,-28.164467525936576,-35.79797988612318,20.250049789184192,32.63038722198242,-6.665948691636852,45.082111939304674,-24.261514223646973,37.477982805824176,8.290504078747563,-21.743146394592053,21.649280111251155,-29.84045780654986,-7.882177418024318,-11.615474940279242,-17.328488926752772,4.14912148751424,-10.81945238746973,-6.7904773224962796,-41.2880441617917,4.536075422695268,-18.887488605188622,-44.8058123088202,-3.333719850420428,-19.689252383566732,7.462336308019102,21.122912937056135,-15.955811483141888,13.79793480483898,-1.524446848758091,-18.82830471062159,-15.793360075536016,22.019287665962075,-24.769499440031513,12.562843298418253,9.301524753799004,42.12962889722918,-42.46793100693489,24.56642682110873,19.360962853639585,81.86840993158336,2.160037283484884,21.593004295964256,-20.29370240658502,-5.644466417129865,14.429422623986447,42.43112846038452,30.894569142990584,19.60680182784723,18.28745966130156,-6.164737159641581,-13.942826459340269,17.166597288206308,-12.87167656533038,27.071552113060477,27.829868110516912,18.299460448262813,-24.374955446706398,18.149678595722747,-10.20309625847492,13.503574427311433,-31.095153736453035,-13.111607941833592,-49.158369558423274],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":13,\"nNeurons\":13,\"weights\":[19.132636780697823,18.15493216638366,18.012959428711753,-49.31570279017766,11.408386574610438,-19.35206426906234,11.807047523113969,43.04659745510681,-13.21212743828233,11.097000864581137,-29.86708601250589,-59.694881690070225,16.062427984451453,17.080114449265228,16.991200847880958,57.12017381863605,-6.734102984052543,24.419886164528286,10.280226596806461,-4.3085924549295,-44.57220401208619,17.655549888495393,-25.844205820875878,-8.661720579995642,9.492856361034374,-67.43031072649501,-24.99269152398819,43.93812895134041,1.4148300663646303,21.649967089032515,2.327943349973458,-21.665768977917114,-17.202062860783748,-10.156780182068447,-11.135912374782254,-3.099597948142552,2.088957095573218,-17.1621553137291,-1.3503137407838757,-14.915163386394928,-13.377765488085062,9.224951194698424,19.266008469949824,1.5329082747555034,6.495113341687718,-9.613330038467849,-36.736170348886894,8.889533705182577,-52.28028061847279,18.228263092148996,-22.582341555698946,11.04348021408742,-8.026703338827248,20.700156484173597,-13.725882820797452,32.53525414275573,5.336397746309821,-46.441650255471444,-45.87594756345619,-4.840737176016933,11.811379988111575,11.850218249625037,17.761879215121592,-47.232356395875044,3.564480239852141,-39.13464725245354,25.157912165321545,45.53334445363381,-9.25959825127141,12.113695258314305,-42.38926807413844,-36.774629469499615,7.568575614984717,-29.703209969003396,16.227420576807884,-38.610506665141706,13.62840183309571,-7.939381059542442,46.1297920736156,-17.985485110773308,9.980107264802994,-7.9264122680625855,13.813457567114419,32.44135839431695,-3.048056819225264,-7.431542421207569,-22.535205074543658,28.868887756066965,-1.9716005940991832,16.508270911295785,37.80195276883252,10.703208285497647,-31.63841204041007,12.989033078013525,44.35617128725635,-20.628199743190468,3.291043575890962,1.3028854612323726,-3.6282581594759886,8.57735230931862,4.73081047902643,-25.383102678130335,-1.8499345375181724,26.76403283782035,-1.1338025821886895,14.2816039541715,-49.39795778514123,18.15872536006498,24.65335363602097,15.389076441108706,-30.783324411188083,-18.9670408214468,-18.79066891323383,68.59414258423774,32.147999877266926,-20.624869757274855,9.055982072499837,14.866877298782766,5.278658319259941,31.934553276204504,-6.691946145552958,3.2335929720118664,-24.280412459051202,-32.33806618380608,-34.74185862182384,-10.111508478541603,-23.808061808196836,40.71462053869805,2.698814188822351,2.4098714299355226,-50.805122118870884,32.65455785285144,-20.05589176375899,25.883456189214666,-8.63282465741971,14.46100647624955,-23.90455414598043,-12.635185673974934,1.8235171673938921,-10.251542748448768,1.0044650772022194,40.53004318219889,23.13134863216555,-18.817339874437913,-17.692415839742065,16.009349422712543,8.154879196261692,15.840183005942961,22.09698952038025,-38.72629649453317,-9.509320884248874,-45.6840429014076,36.5553341707979,19.24880853679618,-23.708626753399358,-25.592836476308836,-6.9340055926122055,-0.9432372707775326,-29.227503655250953,-19.12551460570765,-11.632034942121507,-58.72278344610789,14.733670988934605,14.118907806446698,-13.175374681100578,8.782992995100573,-37.42319584084488,-17.241470902957214,-13.866481082907077,-35.427921879981966,-8.109200376583061,-12.731181351449653,-5.691241367264058,13.954115636919163,-0.43396295299590315,-12.491234438308087,3.2325629636256124,-26.925085792480655,53.52814420708346,15.51252392256657,3.370079038673962,11.173464946239216],\"outputs\":[0,0,0,0,0,0,0,0,0,0,0,0,0]},{\"nInputs\":13,\"nNeurons\":6,\"weights\":[-22.392564297748272,-20.619837717262666,-35.698021869467915,23.954153299179,-33.7034846551397,-11.407129177225945,14.021894015428073,-9.234286881959168,-58.424390217529286,36.63413875932279,-13.92357639658925,25.953101692674807,-15.06765385339444,-18.43141933467156,-5.755437958089335,5.160729708469749,-19.821487773905606,5.949090501412501,-27.74738994362595,-2.801537729978353,-6.733557576016517,-29.671056630262267,-20.70229306003061,19.37347683814047,-7.111845375322184,30.905962495075503,10.438100597299657,7.9791401355306375,5.861320737216971,14.30838060506458,-11.651613577192476,-13.0763803623455,31.319582284142104,-0.8757244681514824,-46.990549655422086,33.90501681133362,12.423364890336684,47.6036152131114,-17.634809502443897,-3.01839902268709,-27.416850720394066,-34.33553629163831,-9.32180206343485,15.922528959815109,-25.09131894258604,34.46911836950258,36.8998676465182,-10.191977196967065,-26.237817133061252,3.8202868605534634,-13.594917318605253,-48.54204471118022,-10.185140985076814,73.4325539889758,30.262000559696336,-15.074204365305972,-16.217141637324506,9.918009988021836,12.619923675147993,48.60474417779511,-4.4446609771717425,21.253756765156442,-31.678288887298343,1.9324489597532801,39.76414643677925,33.166152567744945,-6.806114901796686,-2.796333997448386,-24.46562415353592,34.39262254632476,27.05282238251704,-9.841077425209527,-38.905977280427365,-6.685517777387945,-0.9834855696935387,-3.993570128273447,-41.8784567448572,-12.175640491131391,-16.411153887201188,-12.099151087844817,-2.68024694666731,-34.17399719999387,-8.786253853276259,11.406389538378114],\"outputs\":[0,0,0,0,0,0]}]","evoParams":[]}
</textarea><br>
				<button class="button button1" onclick="onLoadNetworkButton()">Load network</button><br>
			</div>
		</div>
	</div>
</div>

<script>

const canvas = document.getElementById('canvas');
const canvasW = canvas.scrollWidth, canvasH = canvas.scrollHeight;

const mouse = captureMouse(canvas);
const mouseclick = captureMouseclick(canvas);

const pilotNet = makePilotNet();
// pilotNet.randomize();
// document.getElementById("ID_NET_SETUP").value = pilotNet.toText();
const g_pilot = new NeuralPilot( new Visualizer( new WorldModel(), pilotNet, 10, 10, 780 ), pilotNet );
onLoadNetworkButton();

let g_paused = false;
setPause(g_paused);

onRandomizePosButton();

let counter = 0;
window.onload = function() {
	const ctx = canvas.getContext('2d');
	ctx.fillStyle = "black";
	ctx.fillRect(0, 0, canvasW, canvasH);

	(function drawFrame () {
		counter += 1;

		window.requestAnimationFrame(drawFrame, canvas);
		ctx.clearRect(0, 0, canvasW, canvasH);
		// const t0 = performance.now();

		g_pilot.run(ctx, !g_paused);

		ctx.save();
		ctx.font = "10px sans-serif";
		ctx.textAlign = "left";
		ctx.strokeStyle = 'white';
		ctx.fillStyle = 'white';
		let ty = 25;
		for(let i = 0; i < pilotNet.inputs.length; ++i) {
			const txt = "in[" + i + "] " + pilotNet.inputs[i];
			ctx.fillText(txt, 20, ty);
			ty += 10;
		}
		ty = 25;
		const outVals = pilotNet.nnet._layers[pilotNet.nnet._layers.length - 1].outputs;
		for(let i = 0; i < outVals.length; ++i) {
			const txt = "out[" + i + "] " + outVals[i];
			ctx.fillText(txt, 200, ty);
			ty += 10;
		}
		ctx.restore();

		if(g_pilot.visualizer.model.pods.length == 0) {
			g_pilot.visualizer.drawExplosion(ctx, 5 + 5 * (Math.trunc(counter / 3) % 5));
			setPause(true);
		}

		// const t1 = performance.now();
		// console.log((t1 - t0) + " ms");
	}());
}

function onRandomizePosButton() {
	const pos = new Vec2();
	pos.randomInUnitDisk().multiplyScalar( 500 );
	const vel = new Vec2();
	vel.randomInUnitDisk().multiplyScalar( 5 );
	g_pilot.visualizer.model.rocket.reset(pos, vel);

	g_pilot.visualizer.model.pods = [];
	/*
	for(x = -2; x < 3; ++x) {
		for(y = -2; y < 3; ++y) {
			if(x == 0 || y == 0)
				continue;
			g_pilot.visualizer.model.pods.push( new Vec2().randomInUnitDisk().multiplyScalar( 25 ).addComponents( x * 100, y * 100 ) );
		}
	}
	*/
	g_pilot.visualizer.model.pods.push( new Vec2().randomInUnitDisk().normalize().multiplyScalar( 200 + Math.random() * 200 ) );

	setPause(false);
}

function onSetPosButton() {
	const x = parseFloat(document.getElementById("ID_POS_X").value);
	const y = parseFloat(document.getElementById("ID_POS_Y").value);
	const pos = new Vec2(x, y);
	const vel = new Vec2();
	g_pilot.visualizer.model.rocket.reset(pos, vel);
}

function onLoadNetworkButton() {
	g_pilot.pilotNet.fromText(document.getElementById("ID_NET_SETUP").value);
}

function onPauseButton() {
	setPause(!g_paused);
}

function setPause(doPause) {
	g_paused = doPause;
	document.getElementById("PAUSE_STATUS").innerHTML = "Pause " + (g_paused ? "ON" : "OFF");
}

</script>

</body>
</html>
