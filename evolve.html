<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Evolving Circles</title>
</head>
<body>

<script src="drawing.js"></script>
<script src="vec2.js"></script>
<script src="random.js"></script>
<script src="worldmodel.js"></script>
<script src="visualizer.js"></script>
<script src="mouse.js"></script>
<script src="neurallayer.js"></script>
<script src="neuralnet.js"></script>
<script src="pilotnet.js"></script>
<script src="neuralpilot.js"></script>

<script src="fitnessgraph.js"></script>
<script src="population.js"></script>

<canvas id="canvas" width="1024" height="600"></canvas>
<br>
<button onclick="onRestartButton()">Restart</button>
<br>
Population size: <input type="number" id="ID_POP_SIZE" min="0" value="1000"><br>
Generations/tick: <input type="number" id="ID_GENS_TICK" min="0" value="1"><br>
<br>
Mutation spread: <input type="number" id="ID_MUTATION_SPREAD" min="0" value="25"><br>
Mutation half-life (#generations, 0 to disable): <input type="number" id="ID_MUTATION_HALFLIFE" min="0" value="100">

<script>

let g_pop_size = 0;
let g_gens_tick = 0;
let g_mutation_spread = 0;
let g_mutation_halflife = 0;

function read_parameters() {
	g_pop_size = parseFloat(document.getElementById("ID_POP_SIZE").value);
	g_gens_tick = parseFloat(document.getElementById("ID_GENS_TICK").value);
	g_mutation_spread = parseFloat(document.getElementById("ID_MUTATION_SPREAD").value);
	g_mutation_halflife = parseFloat(document.getElementById("ID_MUTATION_HALFLIFE").value);
}
read_parameters();

///////////////////////////////////////////////////////////

// Re-use these for every individual
const g_accel = new Vec2();
const g_model = new WorldModel();

function Individual()
{
	this.fitness = 0;
	this.pilotNet = new PilotNet( [ 4, 4] );
}

Individual.prototype.mutate = function(spread)
{
}

Individual.prototype.randomize = function()
{
	this.pilotNet.randomize();
}

Individual.prototype.copy = function(other)
{
	this.fitness = other.fitness;
	this.pilotNet.copy(other.pilotNet);
}

Individual.prototype.evaluate = function()
{
	let fitness = 0;
	g_model.particle.pos.randomInUnitDisk().multiplyScalar( 300 );
	g_model.particle.vel.randomInUnitDisk().multiplyScalar( 10 );
	for(let time = 0; time < 5 * 60; ++time) {
		g_accel.clear();
		this.pilotNet.run( g_accel, g_model );
		g_model.run( g_accel );
	}
	this.fitness = fitness;
}

Individual.prototype.get_fitness = function()
{
	return this.fitness;
}

///////////////////////////////////////////////////////////
const g_fitnessgraph = new FitnessGraph( 0, 500, canvas.width, 100 );

let g_population = new Population(g_pop_size, function() {return new Individual()});


let frame = 1;
window.onload = function()
{
	const canvas = document.getElementById('canvas');
	const context = canvas.getContext('2d');

	(function drawFrame () {
		window.requestAnimationFrame( drawFrame, canvas );
		context.clearRect( 0, 0, canvas.width, canvas.height );
		frame += 1;

		const halflife_factor = (g_mutation_halflife > 0)
			? Math.pow(2, -frame / g_mutation_halflife) : 1;
		const spread = g_mutation_spread * halflife_factor;
		let fitness = 0;
		fitness = g_population.evolve(spread);

		g_fitnessgraph.push( fitness );
		g_fitnessgraph.draw( context );
	}());
}

function onRestartButton()
{
	g_fitnessgraph.clear();
}

</script>
</body>
</html>
